<div class="container mt-4 monoprix-cashflow">
  <!-- En-tête amélioré -->
  <div class="d-flex align-items-center mb-4">

    <div>
      <h2 class="mb-1 fw-bold">CashFlow</h2>
    </div>
  </div>

  <!-- Formulaire dans une carte -->
  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-white border-0 py-3">
      <h5 class="mb-0 fw-bold"><i class="mdi mdi-tune me-2 text-monoprix-red"></i>simulation parameters </h5>
    </div>
    <div class="card-body pt-0">
      <form (ngSubmit)="onSubmit()">
        <!-- Sélection du magasin -->
        <div class="row mb-4 g-3 align-items-end">
          <div class="col-md-8">
            <label for="store" class="form-label fw-bold small">Store</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-monoprix-light-grey"><i class="mdi mdi-storefront text-monoprix-red"></i></span>
              <select class="form-select form-select-lg" [(ngModel)]="formData.store" name="store" required>
                <option value="">Select store </option>
                <option *ngFor="let store of stores" [value]="store">{{ store }}</option>
              </select>
            </div>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-monoprix-red w-100 py-3 fw-bold">
              <i class="mdi mdi-chart-line me-2"></i>Generate prevision
            </button>
          </div>
        </div>

        <!-- Section simulation -->
        <div class="bg-monoprix-light-grey p-4 rounded-3">
          <h5 class="mb-4 fw-bold"><i class="mdi mdi-flask-outline text-monoprix-red me-2"></i>what if </h5>

          <div class="row g-4">
            <div class="col-md-3">
              <label class="form-label small fw-bold"> Sales transformation (%)</label>
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="mdi mdi-percent text-monoprix-red"></i></span>
                <input type="number" step="1" class="form-control" [(ngModel)]="formData.sales_change"
                       name="sales_change" placeholder="ex: +10">
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label small fw-bold"> stock  transformation (%)</label>
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="mdi mdi-package-variant text-monoprix-red"></i></span>
                <input type="number" step="1" class="form-control" [(ngModel)]="formData.inventory_change"
                       name="inventory_change" placeholder="ex: -10">
              </div>
            </div>

            <div class="col-md-3">
              <label class="form-label small fw-bold">Supplier delay (days)</label>
              <div class="input-group">
                <span class="input-group-text bg-white"><i class="mdi mdi-clock-outline text-monoprix-red"></i></span>
                <input type="number" class="form-control" [(ngModel)]="formData.supplier_delay"
                       name="supplier_delay" placeholder="ex: 3">
              </div>
            </div>

            <div class="col-md-3 d-flex align-items-end">
              <button type="submit" class="btn btn-monoprix-red w-100 py-2 fw-bold">
                <i class="mdi mdi-play me-2"></i>Start  simulation
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Résultats -->
  <div *ngIf="cashData.length > 0">
    <!-- En-tête des résultats -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h4 class="fw-bold"><i class="mdi mdi-chart-areaspline text-monoprix-red me-2"></i>Résultats pour: <span class="text-monoprix-red">{{ formData.store }}</span></h4>
        <p class="text-monoprix-anthracite mb-0">Période du {{ cashData[0].date | date:'dd/MM/yyyy' }} au {{ cashData[cashData.length-1].date | date:'dd/MM/yyyy' }}</p>
      </div>
      <button class="btn btn-outline-monoprix-red" (click)="downloadPdf()">
        <i class="mdi mdi-file-pdf me-1"></i>Export PDF
      </button>
    </div>

    <!-- Graphique -->
    <div class="card shadow-sm mb-4 border-0">
      <div class="card-body p-0">
        <div class="chart-container" style="position: relative; height:400px;">
          <canvas #cashChart></canvas>
        </div>
      </div>
    </div>

    <!-- Sélecteur de date -->
    <div class="card shadow-sm mb-4 border-0">
      <div class="card-body">
        <h5 class="mb-3 fw-bold"><i class="mdi mdi-calendar-month text-monoprix-red me-2"></i>Détail par jour</h5>
        <div class="row align-items-center">
          <div class="col-md-4 mb-3 mb-md-0">
            <label class="form-label fw-bold small">Sélectionnez une date:</label>
            <select class="form-select" [(ngModel)]="selectedDate" (change)="updateSelectedRow()">
              <option *ngFor="let day of cashData" [value]="day.date">{{ day.date | date:'dd/MM/yyyy' }}</option>
            </select>
          </div>
          <div class="col-md-8">
            <div class="d-flex overflow-auto py-2">
              <div *ngFor="let day of cashData"
                   class="day-picker me-2 text-center cursor-pointer"
                   [class.bg-monoprix-red]="day.date === selectedDate"
                   [class.bg-danger]="day.cash_shortage && day.date !== selectedDate"
                   [class.bg-success]="!day.cash_shortage && day.date !== selectedDate"
                   (click)="selectedDate = day.date; updateSelectedRow()">
                <div class="small">{{ day.date | date:'EEE' }}</div>
                <div class="fw-bold">{{ day.date | date:'d' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tableau de détail -->
    <div class="card shadow-sm mb-4 border-0">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-monoprix-light-grey">
              <tr>
                <th class="ps-4">Date</th>
                <th class="text-end">Ventes</th>
                <th class="text-end">Paiements</th>
                <th class="text-end">Achats</th>
                <th class="text-end">Salaires</th>
                <th class="text-end">Loyer</th>
                <th class="text-end">Dépenses</th>
                <th class="text-end">Flux net</th>
                <th class="text-end">Trésorerie</th>
                <th class="pe-4">Statut</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="selectedRow" [class.table-warning]="selectedRow.cash_shortage">
                <td class="ps-4"><strong>{{ selectedRow.date | date:'EEE d MMM' }}</strong></td>
                <td class="text-end">{{ selectedRow.expected_sales | number:'1.0-0' }} €</td>
                <td class="text-end">{{ selectedRow.supplier_payment | number:'1.0-0' }} €</td>
                <td class="text-end">{{ selectedRow.inventory_purchase | number:'1.0-0' }} €</td>
                <td class="text-end">{{ selectedRow.salaries | number:'1.0-0' }} €</td>
                <td class="text-end">{{ selectedRow.rent | number:'1.0-0' }} €</td>
                <td class="text-end">{{ selectedRow.total_expenses | number:'1.0-0' }} €</td>
                <td class="text-end fw-bold" [ngClass]="{'text-monoprix-red': selectedRow.net_cash_flow < 0, 'text-success': selectedRow.net_cash_flow >= 0}">
                  {{ selectedRow.net_cash_flow | number:'1.0-0' }} €
                </td>
                <td class="text-end fw-bold" [ngClass]="{'text-monoprix-red': selectedRow.cumulative_cash < 0, 'text-success': selectedRow.cumulative_cash >= 0}">
                  {{ selectedRow.cumulative_cash | number:'1.0-0' }} €
                </td>
                <td class="pe-4">
                  <span *ngIf="selectedRow.cash_shortage" class="badge bg-monoprix-red">
                    <i class="mdi mdi-alert-circle me-1"></i>Déficit
                  </span>
                  <span *ngIf="!selectedRow.cash_shortage" class="badge bg-success">
                    <i class="mdi mdi-check-circle me-1"></i>OK
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Recommandations -->
    <div class="card shadow-sm border-0">
      <div class="card-body">
        <h5 class="mb-3 fw-bold"><i class="mdi mdi-lightbulb-on text-monoprix-red me-2"></i>Recommandation</h5>
        <div class="alert rounded-3" [ngClass]="{'alert-monoprix-red': hasDeficit, 'alert-info': !hasDeficit}">
          <div class="d-flex align-items-center">
            <i class="mdi mdi-24px me-3" [class.mdi-alert]="hasDeficit" [class.mdi-information]="!hasDeficit"></i>
            <div [innerHTML]="recommendation"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- État vide -->
  <div *ngIf="cashData.length === 0" class="text-center py-5 bg-monoprix-light-grey rounded-3">
    <i class="mdi mdi-cash-multiple fa-4x text-monoprix-anthracite mb-3"></i>
    <h4 class="text-monoprix-anthracite">No Data Available</h4>
    <p class="text-monoprix-anthracite">Set up a simulation to see the results</p>

  </div>
</div>
